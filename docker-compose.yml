version: "3.9"

services:
  rabbitmq:
    image: rabbitmq:3-management
    container_name: rabbitmq_container
    ports:
      - "5672:5672"     
      - "15672:15672"    
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - backend

  message-broker:
    build: .
    container_name: message_broker_container
    platform: linux/amd64
    depends_on:
      - rabbitmq
    ports:
      - "8001:8001"
      - "50051:50051"
    environment:
      - PYTHONUNBUFFERED=1
      - RABBITMQ_HOST=rabbitmq
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
      
    # HAProxy Load Balancer
  load-balancer:
    image: haproxy:2.8-alpine
    container_name: load-balancer
    volumes:
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    networks:
      - backend
    depends_on:
      - task-service
      - voting-service
      #- user_service
      #- game_service
      #- town
      #- characters
      #- rumors-service
    restart: unless-stopped
    ports:
      - "8404:8404" # HAProxy stats page
      - "8180:8180"
      - "8181:8181"

#  characters:
#    image: livia994/characterservice:latest
#    container_name: characters_container
#    platform: linux/amd64
#    depends_on:
#      message-broker:
#        condition: service_healthy
#      mongo:
#        condition: service_started
#    environment:
#      - MESSAGE_BROKER_URL=http://message-broker:8001
#      - MONGO_URI=mongodb://mongo:27017/characterDB
#      - PORT=4002
#    ports:
#      - "4002:4002"
#    networks:
#      - backend
#
#  town:
#    image: livia994/townservice:latest
#    container_name: town_container
#    platform: linux/amd64
#    depends_on:
#      message-broker:
#        condition: service_healthy
#      mongo:
#        condition: service_started
#    environment:
#      - MESSAGE_BROKER_URL=http://message-broker:8001
#      - MONGO_URI=mongodb://mongo:27017/townDB
#      - PORT=4001
#    ports:
#      - "4001:4001"
#    networks:
#      - backend
#
#  mongo:
#    image: mongo:4.4
#    container_name: mongo_container
#    platform: linux/amd64
#    ports:
#      - "27017:27017"
#    volumes:
#      - mongo_data:/data/db
#    networks:
#      - backend
      
  postgres-voting:
    container_name: postgres-voting
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: voting_service
      PGDATA: /data/postgres
    volumes:
      - postgres-voting:/data/postgres
    ports:
      - "5442:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      retries: 5
      timeout: 5s

  postgres-task:
    container_name: postgres-task
    image: postgres:15
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: task_service
      PGDATA: /data/postgres
    volumes:
      - postgres-task:/data/postgres
    ports:
      - "5443:5432"
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 5s
      retries: 5
      timeout: 5s

  voting-service:
    image: vladamusin/voting_service:0.0.11
    deploy:
      replicas: 2
    #    container_name: voting-service
    #    ports:
    #      - "8181:8181"
    depends_on:
      postgres-voting:
        condition: service_healthy
      message-broker:
        condition: service_healthy
    networks:
      - backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-voting:5432/voting_service
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      MESSAGE_BROKER_URL: message-broker:50051  
    restart: unless-stopped

  task-service:
    image: vladamusin/task_service:0.0.25
    deploy:
      replicas: 2
    #    container_name: task-service
    #    ports:
    #      - "8180:8180"
    depends_on:
      postgres-task:
        condition: service_healthy
      message-broker:
        condition: service_healthy
    networks:
      - backend
    environment:
      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-task:5432/task_service
      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
      CHARACTER_SERVICE_URL: http://task-proxy:8000
      MESSAGE_BROKER_URL: message-broker:50051
    restart: unless-stopped


networks:
  backend:
    driver: bridge

volumes:
  mongo_data:
  rabbitmq_data:
  postgres-task:
  postgres-voting:
